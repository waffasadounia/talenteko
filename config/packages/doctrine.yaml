# config/packages/doctrine.yaml
doctrine:
  dbal:
    # DSN principal â†’ dÃ©fini dans .env / .env.local
    url: '%env(resolve:DATABASE_URL)%'

    # Forcer la version exacte de MariaDB (Ã©vite erreurs Doctrine avec migrations)
    server_version: 'mariadb-10.4.32'

    # Charset par dÃ©faut (UTF-8 full)
    charset: utf8mb4
    default_table_options:
      charset: utf8mb4
      collate: utf8mb4_unicode_ci

  orm:
    # GÃ©nÃ©ration auto des proxies (utile en dev, dÃ©sactivÃ© en prod)
    auto_generate_proxy_classes: true
    enable_lazy_ghost_objects: true

    naming_strategy: doctrine.orm.naming_strategy.underscore_number_aware
    auto_mapping: true

    mappings:
      App:
        is_bundle: false
        type: attribute
        dir: '%kernel.project_dir%/src/Entity'
        prefix: 'App\Entity'
        alias: App

when@test:
  doctrine:
    dbal:
      # DB dÃ©diÃ©e aux tests (purgÃ©e Ã  chaque run)
      url: '%env(resolve:DATABASE_URL_TEST)%'
    orm:
      auto_generate_proxy_classes: true
      # En tests, activer schema validation stricte
      validate_schema: true

when@prod:
  doctrine:
    orm:
      # En prod, les proxies sont gÃ©nÃ©rÃ©s au dÃ©ploiement â†’ meilleures perfs
      auto_generate_proxy_classes: false
