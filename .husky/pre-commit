#!/bin/sh

echo "ðŸ” VÃ©rification pre-commit TalentÃ‰kÃ´..."

# VÃ©rif syntaxe PHP rapide
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.php$')
for FILE in $FILES; do
  php -l "$FILE" || exit 1
done

# VÃ©rif encodage/EOL (fix auto)
for FILE in $(git diff --cached --name-only); do
  if [ -f "$FILE" ]; then
    # Supprime BOM
    if grep -Iq $'\xEF\xBB\xBF' "$FILE"; then
      tail -c +4 "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"
      git add "$FILE"
      echo "ðŸ”§ BOM supprimÃ© : $FILE"
    fi
    # CRLF â†’ LF
    if grep -Iq $'\r' "$FILE"; then
      sed -i 's/\r$//' "$FILE"
      git add "$FILE"
      echo "ðŸ”§ Fins de ligne converties : $FILE"
    fi
    # Ajout newline finale
    if [ -s "$FILE" ] && ! tail -c 1 "$FILE" | grep -q $'\n'; then
      echo "" >> "$FILE"
      git add "$FILE"
      echo "ðŸ”§ Ajout newline finale : $FILE"
    fi
  fi
done
echo "âœ… Encodage/EOL validÃ©s"

# Lint-staged (auto-fix JS/CSS/MD si config)
npx lint-staged || exit 1

# Validation composer.json
composer validate --no-check-publish || exit 1

# JS/CSS lint uniquement (TwigCS reportÃ© au push)
npm run lint:js || exit 1
npm run lint:css || exit 1

echo "âœ… Pre-commit terminÃ© (rapide)"
