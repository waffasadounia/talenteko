#!/bin/sh
# .husky/pre-commit
# ======================================================
# Hook Git — TalentÉkô
# Vérifie rapidement la qualité avant commit
# ======================================================

set -e  # Arrêt sur erreurs réelles uniquement

echo "Vérification pre-commit TalentÉkô..."

# 1) Vérif syntaxe PHP rapide
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.php$' || true)
for FILE in $FILES; do
  composer exec -- php -l "$FILE" >/dev/null || {
    echo " Erreur de syntaxe PHP dans $FILE"
    exit 1
  }
done

# 2) Vérif encodage/EOL (fix auto)
for FILE in $(git diff --cached --name-only); do
  if [ -f "$FILE" ]; then
    # Supprime BOM
    if head -c3 "$FILE" | grep -q $'\xEF\xBB\xBF'; then
      tail -c +4 "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"
      git add "$FILE"
      echo " BOM supprimé : $FILE"
    fi
    # CRLF → LF
    if grep -Iq $'\r' "$FILE"; then
      sed -i 's/\r$//' "$FILE"
      git add "$FILE"
      echo " Fins de ligne converties : $FILE"
    fi
    # Ajout newline finale
    if [ -s "$FILE" ] && ! tail -c 1 "$FILE" | grep -q $'\n'; then
      echo "" >> "$FILE"
      git add "$FILE"
      echo " Ajout newline finale : $FILE"
    fi
  fi
done
echo " Encodage/EOL validés"

# 3) Lint-staged (tolérant si aucun fichier applicable)
if npx lint-staged; then
  echo " Lint-staged OK"
else
  STATUS=$?
  if [ "$STATUS" -eq 1 ]; then
    echo " Aucun fichier applicable pour lint-staged (OK)"
  else
    echo " Lint-staged échoué (code $STATUS)"
    exit $STATUS
  fi
fi

# 4) Validation composer.json
if ! composer validate --no-check-publish; then
  echo " composer.json invalide"
  exit 1
fi

echo " Pre-commit terminé avec succès"
exit 0
