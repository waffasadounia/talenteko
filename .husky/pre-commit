#!/bin/sh
# .husky/pre-commit
# ======================================================
# Hook Git â€” TalentÃ‰kÃ´
# VÃ©rifie rapidement la qualitÃ© avant commit
# ======================================================

echo "ğŸ” VÃ©rification pre-commit TalentÃ‰kÃ´..."

# 1) VÃ©rif syntaxe PHP rapide
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.php$')
for FILE in $FILES; do
  composer exec -- php -l "$FILE" || {
    echo "âŒ Erreur de syntaxe PHP dans $FILE"
    exit 1
  }
done

# 2) VÃ©rif encodage/EOL (fix auto)
for FILE in $(git diff --cached --name-only); do
  if [ -f "$FILE" ]; then
    # Supprime BOM
    if head -c3 "$FILE" | grep -q $'\xEF\xBB\xBF'; then
      tail -c +4 "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"
      git add "$FILE"
      echo "ğŸ”§ BOM supprimÃ© : $FILE"
    fi
    # CRLF â†’ LF
    if grep -Iq $'\r' "$FILE"; then
      sed -i 's/\r$//' "$FILE"
      git add "$FILE"
      echo "ğŸ”§ Fins de ligne converties : $FILE"
    fi
    # Ajout newline finale
    if [ -s "$FILE" ] && ! tail -c 1 "$FILE" | grep -q $'\n'; then
      echo "" >> "$FILE"
      git add "$FILE"
      echo "ğŸ”§ Ajout newline finale : $FILE"
    fi
  fi
done
echo "âœ… Encodage/EOL validÃ©s"

# 3) Lint-staged (Prettier, TwigCS, PHP-CS-Fixer, etc.)
npx lint-staged || {
  echo "âŒ Lint-staged Ã©chouÃ©"
  exit 1
}

# 4) Validation composer.json
composer validate --no-check-publish || {
  echo "âŒ composer.json invalide"
  exit 1
}

echo "âœ… Pre-commit terminÃ© avec succÃ¨s"
