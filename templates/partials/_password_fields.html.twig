{# ============================================================================
   Partial : Mot de passe + Confirmation
   Compatible Stimulus (password-strength, password-confirm)
   Gestion erreurs : .is-invalid + .form-error-block
   ============================================================================ #}

{% set is_invalid_first  = form_errors(field_first)|length > 0 %}
{% set is_invalid_second = form_errors(field_second)|length > 0 %}

{% set id_first_errors  = field_first.vars.id ~ '-errors' %}
{% set id_second_errors = field_second.vars.id ~ '-errors' %}

<div data-controller="password-strength password-confirm" class="space-y-6">

    {# ========================= MOT DE PASSE ========================= #}
    <div class="space-y-1">

        <label for="{{ field_first.vars.id }}" class="form-label">
            {{ label_first|default('Mot de passe') }}
            {% if field_first.vars.required %}
                <span class="form-required">*</span>
            {% endif %}
        </label>

        {{ form_widget(field_first, {
            attr: {
                class: 'form-input ' ~ (is_invalid_first ? 'is-invalid' : ''),
                autocomplete: 'new-password',
                'aria-invalid': is_invalid_first ? 'true' : 'false',
                'aria-describedby': is_invalid_first ? id_first_errors : null,
                'data-password-strength-target': 'input',
                'data-password-confirm-target': 'original',
                'data-action': 'input->password-strength#check input->password-confirm#check'
            }
        }) }}

        <div data-password-strength-target="feedback"
             class="mt-2 text-xs space-y-1"
             aria-live="polite"></div>

        {% if is_invalid_first %}
            <div id="{{ id_first_errors }}" class="form-error-block" role="alert">
                <i class="fa-solid fa-circle-exclamation"></i>
                <div>{{ form_errors(field_first) }}</div>
            </div>
        {% endif %}
    </div>

    {# ====================== CONFIRMATION ====================== #}
    <div class="space-y-1">

        <label for="{{ field_second.vars.id }}" class="form-label">
            {{ label_second|default('Confirmer le mot de passe') }}
            {% if field_second.vars.required %}
                <span class="form-required">*</span>
            {% endif %}
        </label>

        {{ form_widget(field_second, {
            attr: {
                class: 'form-input ' ~ (is_invalid_second ? 'is-invalid' : ''),
                autocomplete: 'new-password',
                'aria-invalid': is_invalid_second ? 'true' : 'false',
                'aria-describedby': is_invalid_second ? id_second_errors : null,
                'data-password-confirm-target': 'confirm',
                'data-action': 'input->password-confirm#check'
            }
        }) }}

        <div data-password-confirm-target="feedback"
             class="text-xs mt-1 min-h-[18px]"
             aria-live="polite"></div>

        {% if is_invalid_second %}
            <div id="{{ id_second_errors }}" class="form-error-block" role="alert">
                <i class="fa-solid fa-circle-exclamation"></i>
                <div>{{ form_errors(field_second) }}</div>
            </div>
        {% endif %}
    </div>

</div>
